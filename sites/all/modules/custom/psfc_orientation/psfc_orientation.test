<?php

/**
 * @file tests for psfc_orientation module
 */

/**
 * PsfcOrientationCase tests orientation functions.
 */
class PsfcOrientationCase extends DrupalWebTestCase {
  private $nids_to_delete = array();
  public static function getInfo() {
    return array(
      'name' => 'PSFC Orientation module tests',
      'description' => 'Tests the proper functioning of the orientation module.'
    );
  }

  function setUp() {
    parent::setUp(array('psfc_orientation_features', 'psfc_user_fields'));
  }

  function tearDown() {
    while(list(, $nid) = each($this->nids_to_delete)) {
      node_delete($nid);
    }
    parent::tearDown();
  }
  /**
   * Test creation of orientations
   *
   * These tests should demonstrate that the cron job code that automatically
   * creates orientations is working properly.
   */
  function testCreateOrientation() {
    // Make up an arbitrary repeat rule and test to ensure it gets created
    // using the functions used by the cron job.
    $rule = array('day_of_week' => 'Thursday', 'time_of_day' => '5:30 am', 'capacity' => 10);
    psfc_orientation_create_based_on_repeat_rule($rule);

    // See if an orientation node was created for the right date.
    $from = strtotime("Last Thursday");
    $time = array('hour' => 5, 'minute' => 30, 'ampm' => 'am');
    $next_ort = psfc_orientation_determine_next_repeat($time, $from);
    $node_created = $this->orientationExists($next_ort);
    $this->assertTrue($node_created, "Failed to create orientation.");

    // Now, ensure that we don't create orientations on black out dates.
    $rule = array('day_of_week' => 'Friday', 'time_of_day' => '9:30 am', 'capacity' => 10);
    $from = strtotime("Last Friday");
    $time = array('hour' => 9, 'minute' => 30, 'ampm' => 'am');
    $next_ort = psfc_orientation_determine_next_repeat($time, $from);
    // Create a blackout date
    $id = psfc_orientation_insert_blackout_date(date('Y-m-d', $next_ort));
    // Try to create a repeat rule
    psfc_orientation_create_based_on_repeat_rule($rule);
    $node_created = $this->orientationExists($next_ort);
    $this->assertFalse($node_created, "Created orientation during black out time..");

  }

  /**
   * Helper function - check if orientation exists for the given date.
   */
  function orientationExists($timestamp) {
    $next_ort = date('Y-m-d H:i:s', $timestamp);
    // Short cut sql statement to make sure the record exists.
    $sql = "SELECT COUNT(*) AS count FROM {field_data_field_orientation_date} WHERE " .
      "entity_type = 'node' AND bundle = 'orientation' AND field_orientation_date_value ".
      "= :ort_date";
    $result = db_query($sql, array(':ort_date' => $next_ort));
    echo "checking: $next_ort\n";
    return $result->fetchField() == 1 ? TRUE : FALSE;
  }
}


