<?php
/**
 * @file PSFC Orientation module
 */

module_load_include('inc', 'psfc_orientation', 'psfc_orientation.email');

/**
 * Implementation of hook_perm().
 */
function psfc_orientation_perm() {
  return array(
    'administer psfc orientation',
    'sign up for psfc orientation'
    );
}

/**
 * Implementation of hook_menu().
 */
function psfc_orientation_menu() {
  $items = array();

  // this should probably live in a generic helper module.
  // it lives here because this module got here first --nat
  $items['admin/psfc'] = array(
    'title' => 'PSFC Admin Page',
    'description' => 'An Admin landing page for psfc pages',
    'access arguments' => array( 'administer psfc orientation'),
    'page callback' => 'psfc_orientation_temp_admin_land',
  );
  $items['admin/psfc/orientation'] = array(
    'title' => 'Orientation',
    'description' => 'Allow coop workers to change orientation settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_admin_page'),
    'access callback' => 'user_access',
    'access arguments' => array( 'administer psfc orientation'),
    'file' => 'psfc_orientation.admin.inc',
    'weight' => 10,
    'type' => MENU_LOCAL_TASK
  );
  $items['admin/psfc/orientation/overview'] = array(
    'title' => 'Orientation Settings',
    'description' => 'Allow coop workers to change orientation settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_admin_page'),
    'access callback' => 'user_access',
    'access arguments' => array( 'administer psfc orientation'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'file' => 'psfc_orientation.admin.inc',
  );
  $items['admin/psfc/orientation/add-rule'] = array(
    'title' => 'Create Orientation Rule',
    'description' => 'Create a new orientation rule.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_admin_add_rule'),
    'access arguments' => array( 'administer psfc orientation'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'psfc_orientation.admin.inc',
    'weight' => 8,
  );
  $items['admin/psfc/orientation/delete-rule/%psfc_orientation_orid'] = array(
    'title' => 'Delete Orientation Rule',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_admin_delete_rule', 4),
    'access arguments' => array('administer psfc orientation'),
    'type' => MENU_CALLBACK,
    'file' => 'psfc_orientation.admin.inc',
  );
  $items['admin/psfc/orientation/edit-rule/%psfc_orientation_orid'] = array(
    'title' => 'Edit Orientation Rule',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_admin_edit_rule', 4),
    'access arguments' => array('administer psfc orientation'),
    'type' => MENU_CALLBACK,
    'file' => 'psfc_orientation.admin.inc',
  );
  $items['admin/psfc/orientation/add-blackout'] = array(
    'title' => 'Create a Blackout date',
    'description' => 'Orientations will not be automatically created on this date.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_add_blackout'),
    'access arguments' => array( 'administer psfc orientation'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'psfc_orientation.admin.inc',
    'weight' => 10,
  );
  $items['admin/psfc/orientation/delete-blackout/%psfc_orientation_obid'] = array(
    'title' => 'Delete a Blackout Date',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_delete_blackout', 4),
    'access arguments' => array('administer psfc orientation'),
    'type' => MENU_CALLBACK,
    'file' => 'psfc_orientation.admin.inc',
  );
  $items['admin/psfc/orientation/mail'] = array(
    'title' => 'Edit orientation emails',
    'description' => 'Configure default e-mail text for orientation messages.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('psfc_orientation_mail_settings'),
    'access arguments' => array('administer users'),
    'file' => 'psfc_orientation.email.inc',
  );

  return $items;
}

/**
 * Implemetation of hook_cron().
 */
function psfc_orientation_cron() {
  $query = db_query("SELECT * FROM {psfc_orientation_repeat_rules}");
  while ($result = db_fetch_array($query)) {
    if ($result['day_of_week'] == date('l')) {
      $time = psfc_orienation_split_time_of_day($result['orid']);
      $next = psfc_orientation_determine_next_repeat($time);
      $date = date('Y-m-d', $next);
      // The hour needs to be saved GMT so add 4
      $hour = date('H', $next) + 4;
      $time = date(':i:s', $next);
      $time_value = $date .'T'. $hour . $time;
      if (!psfc_orientation_orientation_exists($time_value) && !psfc_orientation_orientation_blacked_out($date)) {
        $node = psfc_orientation_node_build($result, $time_value);
        if ($node->nid) {
          watchdog('psfc_orientation', 'Added an orientation for: '. $next, WATCHDOG_NOTICE);
        }
      }
    }
  }
}

/**
 * Implementation of hook_views_api().
 */
function psfc_orientation_views_api() {
  return array(
    'api' => 2,
    'path' => drupal_get_path('module', 'psfc_orientation'),
    //'path' => drupal_get_path('module', 'psfc_orientation') . '/includes',
  );
}

/**
 *  Wildcard loader function for hook_menu orientation id
 */
function psfc_orientation_orid_load($orid) {
  if (!is_numeric($orid)) {
    return FALSE;
  }
  $checked_orid = db_result(db_query("SELECT orid FROM {psfc_orientation_repeat_rules} WHERE orid = %d", $orid));
  if ($checked_orid == $orid) {
    return $orid;
  }
  return FALSE;
}

/**
 *  Wildcard loader function for hook_menu orientation blackout id
 */
function psfc_orientation_obid_load($obid) {
  if (!is_numeric($obid)) {
    return FALSE;
  }
  $checked_obid = db_result(db_query("SELECT obid FROM {psfc_orientation_blackout_days} WHERE obid = %d", $obid));
  if ($checked_obid == $obid) {
    return $obid;
  }
  return FALSE;
}

/**
 * Implementation of hook_nodeapi().
 */
function psfc_orientation_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if ($node->type == 'orientation_attendee') {
    $recipient = $node->field_email[0]['email'];
    // This is the attendee node.
    $params['node'] = $node;
    switch ($op) {
      case 'insert' :
        // A new attendee as been created for an orientation.
        // Attendee signed self up and is confirmed.
        if ($node->field_attendee_confirmed[0]['value'] == TRUE) {
          drupal_mail('psfc_orientation', 'registration_confirmed', $recipient, language_default(), $params);
        }
        // Attendee was signed up by someone else, must confirm.
        // @TODO make sure we don't email an admin who created the attendee.
        else {
          drupal_mail('psfc_orientation', 'registration_not_confirmed', $recipient, language_default(), $params);
        }
        break;
    }
  }
}

/**
 *  Temporary PSFC admin landing page
 *
 *  TODO: Move this functionality to a better place
 */
function psfc_orientation_temp_admin_land() {
  $output = l('Administer Orientation', 'admin/psfc/orientation');
  return $output;
}

/**
 *  Helper function to return information about an orientation  rule
 *
 * @param $orid
 * Required. The unique id of the orientation repeat rule
 *
 * @return a keyed array with all relevant information about a rule.
 */
function psfc_orientation_get_repeat_rule_info($orid) {
  $result = db_fetch_array(db_query("SELECT * FROM {psfc_orientation_repeat_rules} WHERE orid = %d", $orid));
  return $result;
}

/**
 *  Helper function to determine next repeated orienation
 */
function psfc_orientation_determine_next_repeat($time) {
    $two_weeks = time() + ( 60 * 60 * 24 *14);
    $date = date('l F d', $two_weeks);
    $string = $date .' '. $time['hour'] .':'. $time['minute'] .' '. $time['ampm'];
    $next_orientation = strtotime($string);
  return $next_orientation;
}

/**
 * Helper function to split apart the time_of_day saved in orienation_rule
 */
function psfc_orienation_split_time_of_day($orid) {
  $info = psfc_orientation_get_repeat_rule_info($orid);
  $split0 = split(':', $info['time_of_day']);
  $split1 = split(' ', $split0[1]);

  $time = array();
  $time['hour'] = $split0[0];
  $time['minute'] = $split1[0];
  $time['ampm'] = $split1[1];

  return $time;
}

/**
 * Helper function to determine if there is already an orientation scheduled
 * for a time slot
 *
 * @param $time
 *
 * @return blooean TRUE if there there is an already scheduled orientation
 */
function psfc_orientation_orientation_exists($time) {
  $query = db_query('SELECT cto.field_date_value FROM {content_type_orientation} cto INNER JOIN {node} n ON cto.nid = n.nid AND cto.vid = n.vid WHERE n.status = %d AND cto.field_date_value = "%s"', 1, $time);
  if (db_result($query) == $time) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Helper function to determine if a date is blacked out
 *
 * @param $date a datestring formatted as YYY-MM-DD
 *
 *
 * @return boolean TRUE if $date is blacked out
 */
function psfc_orientation_orientation_blacked_out($date) {
  $date = $date .' 00:00:00';
  $query = db_query('SELECT blackout_date FROM {psfc_orientation_blackout_days} WHERE blackout_date = "%s"', $date);
  while ($result = db_fetch_array($query)) {
    if ($result['blackout_date'] == $date) {
      return TRUE;
    }
  }
  return FALSE;
}

/**
 * Build an orientation node
 *
 * @param $orientation_rule an orientation rule as built by
 *    psfc_orientation_get_repeat_rule_info().
 *
 * @param $time_value the tiime of the desired orientation in the format:
 *    YYYY-MM-DDTHH:MM:SS
 *
 * @return the node object of the new orientation.
 */
function psfc_orientation_node_build($orientation_rule, $time_value) {
  // declare a new node object
  $node = new stdClass();

  // set some values that will not change.
  $node->type = 'orientation';
  $node->uid = 1;
  $node->status = 1;
  $node->created = time();
  $node->changed = time();
  $node->comment = 0;
  $node->promote = 0;
  $node->moderate = 0;
  $node->sticky = 0;
  $node->tnid = 0;
  $node->translate = 0;
  $node->revision_uid = 1;
  $node->revision_timestamp = time();
  $node->body = variable_get('psfc_orientation_default_description', t('PSFC Orientations are blah blah blah'));
  $node->format = 1;

  // Fill in the values from the orientation rule
  $node->field_capacity = array(
    0 => array(
      'value' => $orientation_rule['capacity'],
    ),
  );

  $node->field_date = array(
    0 => array(
      'value' =>   $time_value,
      'timezone' => 'America/New_York',
      'timezone_db' => 'UTC',
      'date_type' => 'date',
    ),
  );

  $node->field_open = array(
    0 => array(
      'value' => 0,
    ),
  );

  // validate and save the node
  node_validate($node);
  node_submit($node);
  node_save($node);
  return $node;
}

/**
 * Helper function to count open slots in an orientation.
 *
 * @param $node
 *   Either an orientation node object or node ID.
 *
 * @return The number of open spaces remaining for the orientation.
 */

function psfc_orientation_attendees($node) {
  if(!is_object($node)){
    $node = node_load($node);
  }
//   $count = db_result(db_query("SELECT COUNT(*) nid FROM {content_type_orientation_attendee} WHERE field_orientation_nid_nid = %d", $node->nid));
  $count = count($node->field_orientation_attendees[0]['items']);
  return $node->field_capacity[0]['value'] - $count;
}